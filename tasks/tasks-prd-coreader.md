# Tasks for PRD: Coreader

Source PRD: `tasks/prd-coreader.md`

## Relevant Files

- `app/server/main.py` - Точка входа backend (FastAPI/другой фреймворк), маршруты диалога/настроек.
- `app/server/rag/pipeline.py` - Пайплайн парсинга, сегментации, индекса, извлечения.
- `app/server/rag/index_store.py` - Хранение эмбеддингов и кэша.
- `app/server/rag/reader.py` - Парсинг Markdown и построение якорей/хэшей абзацев.
- `app/server/rag/retriever.py` - Извлечение релевантных фрагментов.
- `app/server/rag/guardrails.py` - Гардрейлы: только книга/контекст, проверки цитат.
- `app/server/providers/openai_client.py` - Клиент OpenAI (эмбеддинги, генерация), чтение конфигов из .env.
- `app/server/zotero/client.py` - Клиент Zotero Web API и маппинг в YAML-поля.
- `app/server/obsidian/exporter.py` - Экспорт мысли в локальный путь Obsidian с YAML.
- `app/server/dialog/logger.py` - JSONL-журнал: `{ts, role, text, citations}`.
- `app/web/index.html` - Веб-UI точка входа.
- `app/web/assets/main.js` - Логика UI: диалог, граница прочитанного, настройки, экспорт.
- `app/web/assets/styles.css` - Стили.
- `config/.env.example` - Пример переменных окружения.
- `tests/e2e/` - E2E сценарии.
- `tests/unit/` - Unit-тесты модулей пайплайна/интеграций.

### Notes

- Unit-тесты располагать рядом или в `tests/unit/` по модульному принципу.
- E2E проверяют полный путь: ввод → извлечение → цитаты → экспорт → журнал.
- Метрика v1: ≥ 95% ответов содержат точную цитату из книги.

## Tasks

- [x] 1.0 Проектная структура и конфигурация
  - [x] 1.1 Инициализировать структуру директорий `app/server`, `app/web`, `config`, `tests/`.
  - [x] 1.2 Настроить сервер (FastAPI или эквивалент), базовые маршруты `/chat`, `/settings`, `/export`.
  - [x] 1.3 Подключить статическую раздачу UI (локальный веб-UI на localhost).
  - [x] 1.4 Добавить `config/.env.example`, документацию по переменным: OPENAI_API_KEY, ZOTERO_API_KEY, OBSIDIAN_VAULT_PATH.
  - [x] 1.5 Линт/формат (например, ruff/black) и базовый `Makefile` или npm/yarn скрипты.

- [x] 2.0 Хранилище и форматы данных
  - [x] 2.1 Создать каталоги `/data/coreader/book/`, `/data/coreader/context/`, `/data/coreader/dialog/` при старте.
  - [x] 2.2 Реализовать модуль JSONL-журналирования (`dialog/logger.py`).
  - [x] 2.3 Определить схему заметки Obsidian и шаблон YAML (`title`, `book:{zotero_key,title,authors,year,tags}`, `created`).

- [x] 3.0 Парсинг и сегментация Markdown
  - [x] 3.1 Реализовать парсер Markdown книги/контекстов.
  - [x] 3.2 Генерировать якоря абзацев (хэш) и карту заголовков.
  - [x] 3.3 Сегментация под эмбеддинги (размер блока, перекрытие, язык RU/ENG).

- [x] 4.0 Индексация
  - [x] 4.1 Клиент OpenAI эмбеддингов (`text-embedding-3-small`) с локальным кэшем.
  - [x] 4.2 Формат индекса: хранить эмбеддинги и метаданные (файл, якорь, заголовок).
  - [x] 4.3 Утилиты пересборки/инкрементального обновления индекса.

- [x] 5.0 Извлечение и гардрейлы
  - [x] 5.1 Реализовать BM25 (опц.) и векторное извлечение, объединение результатов.
  - [x] 5.2 Гардрейлы: фильтровать фрагменты вне «доступной зоны» и вне источников (книга/контекст).
  - [x] 5.3 Сформировать структуру ответа: краткий текст + список цитат с якорями.

- [x] 6.0 Генерация ответов
  - [x] 6.1 Клиент OpenAI Chat (`gpt-4o-mini`), управление длиной (дефолт 400–600 символов).
  - [x] 6.2 Параметры сократичности: 3 пресета (низкая/средняя/высокая).
  - [x] 6.3 Обязательное включение хотя бы одной точной цитаты из книги или корректный отказ.

- [x] 7.0 Граница прочитанного
  - [x] 7.1 UI-компонент выбора места: заголовок/якорь.
  - [x] 7.2 Серверная валидация и фильтрация контента по границе.
  - [x] 7.3 Отображение визуальной границы в UI.

- [x] 8.0 Цитирование
  - [x] 8.1 Формирование минимальных цитат с указанием заголовка и якоря.
  - [x] 8.2 Автоссылки в UI на место в книге.
  - [x] 8.3 Отказ при невозможности точной цитаты.

- [x] 9.0 Экспорт в Obsidian
  - [x] 9.1 Настройки пути к локальному vault; валидация доступности.
  - [x] 9.2 Генерация заметки и запись в `ObsidianVault/lit/<BookSlug>/`.
  - [x] 9.3 Просмотр YAML перед сохранением; подтверждение пользователем.

- [x] 10.0 Интеграция Zotero Web API
  - [x] 10.1 Клиент: авторизация по API-ключу, выбор библиотеки/коллекции.
  - [x] 10.2 Получение полей `key,title,authors,year,tags` по идентификатору/поиску.
  - [x] 10.3 Маппинг в YAML заметки; обработка оффлайна (кеш последнего ответа — опц.).

- [x] 11.0 Offline-режим
  - [x] 11.1 Глобальный переключатель; отключение сетевых клиентов (OpenAI, Zotero).
  - [x] 11.2 Дружелюбное уведомление о недоступности генерации и метаданных.

- [x] 12.0 Локальный веб-UI
  - [x] 12.1 Экран диалога: ввод, лента, цитаты, кнопка «Сохранить мысль».
  - [x] 12.2 Экран прогресса книги: выбор границы (заголовок/якорь).
  - [x] 12.3 Экран настроек: ключи API, переключатель офлайна, пресеты сократичности, лимит ответа.

- [x] 13.0 Журналирование
  - [x] 13.1 Запись JSONL `{ts, role, text, citations:[{file, anchor}]}`.
  - [x] 13.2 Логи ошибок без PII; ротация/имена `YYYY-MM-DD-HHMM[-N].jsonl`.

- [x] 14.0 Метрики и приёмка
  - [x] 14.1 Автотест на долю ответов с цитатой (цель ≥ 95%).
  - [x] 14.2 Скрипт выборочной ручной проверки точности ссылок.

- [x] 15.0 Тестирование
  - [x] 15.1 Unit: парсер Markdown, якоря, индекс, извлечение, гардрейлы.
  - [x] 15.2 Интеграционные: генерация ответа c цитатой, экспорт в Obsidian, офлайн-режим.
  - [x] 15.3 E2E: сценарии отказа без цитат; соблюдение «границы».

- [x] 16.0 Скрипты и окружение
  - [x] 16.1 `.env.example` и валидация обязательных переменных.
  - [x] 16.2 Скрипты запуска dev/prod, инструкции в README.
