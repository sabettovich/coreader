# PRD: Coreader — Сократический диалог с книгой

## 1. Обзор
Coreader — приложение, ведущее краткий «сократический» диалог строго по содержанию переданной книги (Markdown, RU/ENG), с возможностью извлекать точные цитаты и сохранять мысли пользователя в Obsidian-заметки с метаданными из Zotero. UI — локальный веб-интерфейс (браузер), backend локально; разрешены сетевые вызовы к LLM и Zotero Web API. Предусмотрен переключатель офлайн-режима.

Проблема: читателю нужен собеседник, который помогает понять книгу, задаёт наводящие вопросы и не «галлюцинирует», опираясь только на текст книги и выбранные контексты.

Цель: обеспечить быстрый, лаконичный и строго подтверждённый цитатами диалог по книге, с удобным экспортом мыслей в Obsidian.

## 2. Цели
- Обеспечить диалог «только по книге/контексту» с обязательными краткими цитатами-основаниями.
- Дать пользователю контроль «границы прочитанного» и соблюдать её при ответах.
- Экспортировать мысли в Obsidian с YAML-шапкой и атрибутами книги из Zotero.
- Поддержать локальный веб-UI с онлайн-доступом к LLM и Zotero; предоставить офлайн-переключатель.

## 3. User Stories
- Как читатель-исследователь, я хочу задавать вопросы по книге и получать короткие ответы с точными цитатами, чтобы не тратить время на поиск места в тексте.
- Как читатель-исследователь, я хочу вручную отмечать «прочитанное начало», чтобы ответы не раскрывали спойлеров.
- Как читатель-исследователь, я хочу сохранять собственные мысли в Obsidian с корректными метаданными из Zotero, чтобы накапливать личную базу знаний.

Целевой пользователь: индивидуальный читатель-исследователь (2A). Язык UI — RU; язык книг — RU/ENG.

## 4. Функциональные требования
1. Загрузка данных
   1.1. Импорт одной книги в формате Markdown (UTF-8), RU или ENG.  
   1.2. Импорт дополнительных контекстных файлов (Markdown/TXT и др.).

2. Диалог и RAG-ограничения
   2.1. Ответы формируются только из: (a) книги; (b) контекстных файлов (5A).  
   2.2. В ответ обязательно включать минимум одну точную цитату из книги; из контекста — при необходимости.  
   2.3. При отсутствии достаточного основания возвращать отказ либо предлагать уточнить вопрос (8B).  
   2.4. Сократический стиль: краткие, наводящие вопросы; настраиваемая «степень сократичности» (12B — три пресета).

3. Учёт «прочитанного начала»
   3.1. Пользователь вручную указывает текущее место (границу) по заголовку/якорю (6A).  
   3.2. Система не использует фрагменты за пределами доступной зоны при ответах и цитировании.

4. Цитирование и ссылки
   4.1. Цитата — минимально возможный объём, точная, с указанием места (7C).  
   4.2. Способ адресации — якорь по хэшу абзаца/заголовка; отображение: заголовок раздела + якорь.  
   4.3. Если точную цитату получить нельзя — отказ.

5. Экспорт мыслей в Obsidian
   5.1. Кнопка «Сохранить мысль» создаёт/обновляет Markdown-запись в Obsidian.  
   5.2. Структура: локальный путь к vault; папка `ObsidianVault/lit/<BookSlug>/`.  
   5.3. YAML front matter (минимум): `title`, `book: { zotero_key, title, authors, year, tags }`, `created` (ISO8601).  
   5.4. Поля из Zotero подтягиваются автоматически при наличии связки.

6. Платформы и UI
   6.1. Linux: локальный веб-UI (backend на localhost; фронт в браузере) (3C Linux).  
   6.2. Android: поддержка через PWA/веб-обёртку (3C Android).

7. Интеграции
   7.1. Zotero Web API (10C) для получения метаданных из библиографической записи по ключу/идентификатору.  
   7.2. Obsidian: только локальный путь (9 — A), синхронизация возможна сторонним клиентом, вне Coreader.

8. Режимы сети и приватности
   8.1. По умолчанию разрешены сетевые вызовы к LLM и Zotero (18A).  
   8.2. Переключатель «Offline-режим»: блокирует сетевые вызовы; при включении генерация ответов и автоматическое получение метаданных Zotero недоступны, UI показывает дружелюбное уведомление (Да — 17B для .env и секретов; приватность — локально, без передачи содержимого книг без явного действия пользователя).

9. Хранение и форматы
   9.1. Каталоги:  
       - `/data/coreader/book/` — исходная книга `.md` + индекс.  
       - `/data/coreader/context/` — контекстные файлы.  
       - `/data/coreader/dialog/` — журнал диалога `YYYYMMDD_HHMM.jsonl`.  
       - `ObsidianVault/lit/<BookSlug>/` — заметки пользователя.  
   9.2. Форматы:  
       - Книга/контекст: Markdown (UTF-8).  
       - Диалог: JSONL `{ts, role, text, citations:[{file, anchor}]}`.  
       - Заметка: Markdown + YAML (см. 5.3).

## 5. Нефункциональные требования
- Язык UI: RU. Язык книги: RU/ENG.  
- Производительность: ответы лаконичные; конкретные SLO по времени ответа уточняются.  
- Надёжность: корректная деградация при отсутствии сети (офлайн-режим).  
- Безопасность/секреты: использовать переменные среды; предоставить `.env.example` (17B).  
- Приватность: диалоги и заметки — локально; сетевые вызовы только к LLM/Zotero при выключенном оффлайне.

## 6. Дизайн (высокоуровневый)
- Экран диалога: поле ввода, лента реплик, кнопка «Сохранить мысль», отображение цитат с ссылками-якорями.  
- Экран книги/прогресса: визуальная граница «прочитанного начала».  
- Экспорт в Obsidian: подтверждение перед записью, просмотр пути и YAML.  
- Настройки: ключи API, Offline-режим, степень сократичности (3 пресета), лимит длины ответа (пользовательская настройка — 12C).

## 7. Технические соображения
- Пайплайн RAG: парсинг → сегментация → индексация (векторная + опц. лексическая) → извлечение → лаконичная генерация → прикрепление цитат.  
- Векторный поиск: эмбеддинги через внешний API OpenAI `text-embedding-3-small` (4B), с локальным кэшированием.  
- Генерация ответов: внешний API LLM OpenAI `gpt-4o-mini` (4A), конфигурируемая через .env; дефолтная длина ответа 400–600 символов (настраиваемо).  
- Строгие гардрейлы: источник только книга/контекст; любые «внесценарные» знания помечаются как недопустимые.  
- Offline-режим: отключает вызовы эмбеддингов/LLM/Zotero; тогда доступен только поиск/цитаты из локального индекса без генерации полнотекстового ответа.  
- Обозначение цитат: хэш-якоря абзаца; минимальный объём цитаты; отображение раздела.

## 8. Критерии приёмки
1. Ответы содержат минимум одну точную цитату из книги с корректной ссылкой-якорем, либо корректный отказ/запрос уточнения.  
2. Доступная зона («прочитанное начало») строго соблюдается: ни одна цитата/факт не выходит за границу.  
3. Экспорт в Obsidian создаёт/обновляет заметку по шаблону YAML; поля из Zotero подтягиваются при онлайне.  
4. Offline-режим блокирует сетевые вызовы и корректно информирует пользователя о недоступности генерации и метаданных Zotero.  
5. Журнал диалога ведётся в JSONL с фиксацией цитат и их привязок.

## 9. Метрики успеха
- Базовая метрика v1: доля ответов, содержащих как минимум одну точную цитату из книги (цель ≥ 95%).  
- Дополнительно (опционально): точность ссылок (ручная проверка), доля корректных отказов.

## 10. Out of Scope (v1)
- Суммаризация больших книг (15A).  
- Совместное редактирование (15C).  
- Облачная синхронизация (15D).  
- Мультиязычный UI.

## 11. Открытые вопросы
- Порог/цель по метрике «доля ответов с цитатой» (напр., ≥95%?).  
- Конкретные модели LLM/эмбеддингов и лимиты длины ответа по умолчанию.  
- Точные поля из Zotero (минимальный и полный набор) и формат ссылки на запись.  
- Формальные SLO по времени ответа (P50/P95) в онлайне и офлайне.
