# Техническое задание (ТЗ) на программу «Coreader: Сократический диалог с книгой»

Источник требований: промпт с инструкциями по структурированию ТЗ fileciteturn0file0 и описание функционала программы fileciteturn0file1.

## 1. Общая информация
**Название проекта:** Coreader  
**Цель:** создать приложение, ведущее краткий сократический диалог с читателем строго по содержанию переданной книги (Markdown), с опорой на приложенные контекстные файлы, и умеющее сохранять мысли читателя в Obsidian-заметки с метаданными из Zotero. fileciteturn0file1  
**Краткое описание:** Приложение (Python) для Android и Linux принимает книгу в формате Markdown (RU), дополнительные контекстные файлы (об авторе и/или связанные тексты), отвечает на вопросы читателя только на основе книги, приводит доказательства в виде цитат (и/или кратких выводов), ведёт диалог и журналирует его; по команде читателя сохраняет мысль в Markdown-заметку внутри базы знаний Obsidian, снабжая её YAML-заголовком с атрибутами книги из Zotero. Стиль ответов — лаконичный, в духе сократических диалогов. fileciteturn0file1

## 2. Функциональные требования
2.1. **Загрузка корпуса данных**
- Импорт книги в формате Markdown (обязателен русский язык). fileciteturn0file1  
- Импорт контекстных файлов (об авторе; связанные книги/материалы). fileciteturn0file1

2.2. **Диалог и ограничение источников**
- Вести диалог строго по содержанию книги; не отклоняться к внешним источникам. fileciteturn0file1  
- Разрешено использовать контекстные файлы для уточнений и аргументации. fileciteturn0file1  
- Обязательное доказательство: цитаты из книги (с указанием места) и/или краткая цепочка умозаключений. Если ответ получить нельзя — явно сообщить об этом. fileciteturn0file1  
- Язык диалога — русский. fileciteturn0file1  
- Ответы максимально короткие. fileciteturn0file1

2.3. **Учёт прогресса чтения**
- Если читатель ещё не прочитал книгу целиком, ответы строятся лишь на той части, которую он «мог узнать в начале книги» (см. §8 о трактовке). fileciteturn0file1

2.4. **Память диалога**
- Сохранять весь диалог и использовать его как контекст последующих реплик. fileciteturn0file1

2.5. **Сократический режим**
- Формулировать ответы/вопросы в стиле сократического диалога Платона: помогать читателю рождать мысль, наводящими вопросами. fileciteturn0file1

2.6. **Заметки читателя (Obsidian)**
- По команде читателя сохранять «мысль» в Markdown-файл заметок в составе Obsidian-базы. fileciteturn0file1  
- Каждая заметка имеет корректный YAML-front matter с атрибутами книги из Zotero. fileciteturn0file1

2.7. **Платформы**
- Программа написана на Python. Целевые платформы: Android и Linux. fileciteturn0file1

2.8. **Отказ от ответа**
- Если ответ невозможен по книге/контексту — кратко и явно сообщить об отсутствии ответа. fileciteturn0file1

## 3. Нефункциональные требования
3.1. **Язык/локаль:** RU интерфейс и ответы. fileciteturn0file1  
3.2. **Производительность:** ответы краткие; время ответа — «минимально возможное» (метрика/SLI — **требует уточнения**).  
3.3. **Кроссплатформенность:** сборки/пакеты под Linux и Android (**требует уточнения**: способ упаковки, ABI/минимальные версии ОС).  
3.4. **Хранение данных:** локально, в пользовательских каталогах; структура описана в §6.  
3.5. **Надёжность:** устойчивость к отсутствию части контекстных файлов; корректная деградация с объяснением ограничений.  
3.6. **Безопасность/приватность:** диалоги и заметки не покидают устройство без явного согласия (**требует уточнения**).  
3.7. **UX-ограничения:** ответы лаконичные; цитаты оформляются как блоки со ссылкой на место в тексте. fileciteturn0file1

## 4. Интерфейс пользователя (высокоуровневое)
4.1. **Экран диалога:** поле ввода, лента реплик, кнопка «Сохранить мысль». Отображение цитат и ссылок на место в книге.  
4.2. **Экран книги/прогресса:** индикация текущего «доступного диапазона» текста (см. §8.3).  
4.3. **Экран заметок:** список заметок (из Obsidian-влта), просмотр/переход.  
4.4. **Импорт данных:** выбор файла книги (.md) и контекстных файлов; настройка пути к Obsidian vault и связке с Zotero (**требует уточнения**).  
4.5. **Настройки:** стиль вопросов (степень «сократичности»), формат цитат, ограничения длины ответа.

## 5. Сценарии пользовательского взаимодействия
5.1. **Старт и импорт**
1) Пользователь выбирает Markdown-книгу и, при наличии, контекстные файлы.  
2) Приложение индексирует их (см. §7) и предлагает установить путь к Obsidian-vault.  

5.2. **Диалог**
1) Пользователь задаёт вопрос.  
2) Приложение извлекает релевантные фрагменты из книги (и контекста), формирует краткий ответ, добавляя обязательные цитаты/краткие умозаключения.  
3) Если релевантных фрагментов нет — приложение кратко заявляет об отсутствии ответа.  

5.3. **Сохранение мысли**
1) Пользователь просит сохранить мысль.  
2) Приложение создаёт/дополняет Markdown-заметку в Obsidian с YAML-шапкой по данным Zotero. fileciteturn0file1

5.4. **Чтение неполной книги**
- При помеченной неполной прочитанности ответы ограничиваются «началом книги»/прочитанным диапазоном (см. §8.3). fileciteturn0file1

## 6. Структура хранения данных
6.1. **Каталоги (локально)**
- `/data/coreader/book/` — исходная книга `.md` + индекс.  
- `/data/coreader/context/` — контекстные `.md`/`.txt`/др.  
- `/data/coreader/dialog/` — журнал диалога (`YYYYMMDD_HHMM.jsonl`).  
- `ObsidianVaultPath/Notes/<BookSlug>/` — заметки читателя `.md` с YAML. fileciteturn0file1

6.2. **Форматы**
- **Книга/контекст:** Markdown (UTF-8).  
- **Диалог:** JSONL `{ts, role, text, citations:[{file, anchor}]}`.  
- **Заметка:** Markdown + YAML front matter:  
  ```yaml
  ---
  title: "<Заголовок заметки>"
  book:
    zotero_key: "<ID>"
    title: "<Название>"
    author: "<Автор>"
    year: <Год>
    tags: [<теги>]
  created: "<ISO8601>"
  ---
  ```
  (**Точный набор полей из Zotero — требует уточнения.**) fileciteturn0file1

## 7. Протокол взаимодействия интеллекта с данными
7.1. **Ограниченная генерация (RAG-Guardrails)**
- Источники ответа: (1) книга; (2) контекстные файлы. Внешние источники — запрещены. fileciteturn0file1  
- Пайплайн: парсинг → сегментация → индексация (векторная/лексическая) → извлечение → формирование краткого ответа → прикрепление цитат (минимум одна точная цитата из книги; из контекста — по необходимости).  

7.2. **Обоснование**
- Приложение обязано возвращать цитаты с указанием местоположения (раздел/заголовок/якорь/номер строки, если есть).  
- Если задействуются умозаключения — выдавать краткий вывод (без разглашения внутренних скрытых размышлений модели). (**Требует уточнения** с заказчиком, допустима ли эта форма вместо полной «цепочки ума».) fileciteturn0file1

7.3. **Контекст диалога**
- Автоматическое добавление последних реплик и ссылок на ранее приведённые цитаты.

## 8. Логика обработки данных и ограничения
8.1. **Строгость к источникам**
- Никаких фактов вне книги/контекста; при отсутствии подтверждений — отказ от ответа. fileciteturn0file1

8.2. **Краткость**
- Ограничение длины ответа (символы/токены), по умолчанию «кратчайший возможный» (**конкретные лимиты — требуют уточнения**). fileciteturn0file1

8.3. **Учёт «прочитанного начала»**
- Требуется механизм определения доступной части текста:  
  а) пользователь вручную задаёт «границу прочитанного» (по заголовку/якорю/проценту), или  
  б) приложение ведёт позицию чтения (скролл/страница).  
  (**Выбрать способ — требует уточнения.**) Ответы запрещено строить на фрагментах за пределами доступной зоны. fileciteturn0file1

8.4. **Цитирование**
- Цитаты — точные, с минимальным объёмом, с указанием места. При невозможности точной цитаты — отказ. fileciteturn0file1

8.5. **Язык/стиль**
- Русский язык; тон сократический; наводящие вопросы допустимы, но краткие. fileciteturn0file1

8.6. **Журналирование**
- Все реплики, применённые источники и привязки цитат записываются в журнал диалога. fileciteturn0file1

## 9. Ограничения и запреты
- Запрещено использовать внешние источники/знания, не входящие в книгу/контекст. fileciteturn0file1  
- Запрещено отвечать без цитаты/краткого доказательства при наличии материалa; при его отсутствии — обязателен отказ. fileciteturn0file1  
- Запрещено выходить за пределы «доступной части» для непрочитавшего книгу. fileciteturn0file1  
- Запрещено менять язык ответов (всегда RU). fileciteturn0file1

## 10. Дополнительно (интеграции, расширения)
- **Obsidian:** указание пути к vault; схема размещения заметок; авто-ссылки на книгу/главы (**требует уточнения**). fileciteturn0file1  
- **Zotero:** способ получения метаданных (через локальную БД/экспорт JSON/Better BibTeX — **требует уточнения**). fileciteturn0file1  
- **Android/Linux упаковка:** выбор фреймворка UI, механизмов доступа к ФС, разрешений (**требует уточнения**). fileciteturn0file1  
- **Тестирование:** набор тест-кейсов на проверку: (1) отказ при отсутствии цитат; (2) соблюдение «доступной зоны»; (3) корректность YAML метаданных; (4) лаконичность ответа; (5) журналирование.

---

### Требует уточнения (сводно)
1) Метрики быстродействия и лимиты длины ответа.  
2) Механизм учёта «прочитанного начала» (ручной/автоматический).  
3) Поля YAML из Zotero и канал интеграции с Zotero.  
4) Путь к Obsidian vault и структура ссылок из заметок на книгу.  
5) UI-фреймворк и способ упаковки под Android/Linux; минимальные версии ОС.  
6) Допустимая форма представления «умозаключений» (краткий вывод vs. подробная цепочка). fileciteturn0file1
